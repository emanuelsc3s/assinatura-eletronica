# Diagrama de Fluxo - Assinatura Eletrônica

Este documento apresenta diagramas visuais do fluxo de assinatura.

---

## Fluxo Completo de Assinatura

```
┌──────────────────────────────────────────────────────────────────┐
│                         INÍCIO                                    │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│  1. UPLOAD DO PDF                                                 │
│  ─────────────────                                                │
│  • Usuário faz upload via drag & drop ou clique                   │
│  • Validação de tipo (application/pdf)                            │
│  • Validação de tamanho (max 50MB)                                │
│  • Validação de magic bytes (%PDF-)                               │
│  • Leitura dos bytes em Uint8Array                                │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│  2. CRIAÇÃO DO LOG                                                │
│  ─────────────────                                                │
│  • Gera documentId (UUID)                                         │
│  • Armazena metadados (nome, tamanho, lastModified)               │
│  • Array de assinaturas vazio                                     │
│  • Salva no localStorage                                          │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│  3. VISUALIZAÇÃO                                                  │
│  ─────────────────                                                │
│  • Renderiza PDF com react-pdf + pdfjs-dist                       │
│  • Navegação entre páginas                                        │
│  • Controle de zoom (50% - 200%)                                  │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│  4. PREENCHIMENTO DO FORMULÁRIO                                   │
│  ──────────────────────────────                                   │
│  • Nome completo (min 5, max 100 caracteres)                      │
│  • CPF com validação completa (dígitos verificadores)             │
│  • Máscara automática de CPF                                      │
│  • Validação via Zod + React Hook Form                            │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│  5. PROCESSAMENTO DA ASSINATURA                                   │
│  ───────────────────────────────                                  │
│  • Normaliza nome (uppercase, trim)                               │
│  • Normaliza CPF (apenas dígitos)                                 │
│  • Obtém Device ID do localStorage                                │
│  • Gera timestamp ISO 8601                                        │
│  • Gera hash SHA-256:                                             │
│    hash = SHA256(pdfBytes + "|NAME:x|CPF:y|DEVICE:z|TIME:t|")    │
│  • Cria objeto SignatureData                                      │
│  • Adiciona ao log                                                │
│  • Salva no localStorage                                          │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
                    ┌────────┴────────┐
                    │ Mais assinaturas?│
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ SIM                         │ NÃO
              ▼                             ▼
    ┌─────────────────┐          ┌─────────────────────────────────┐
    │ Voltar ao passo │          │  6. FINALIZAÇÃO DO PDF           │
    │       4         │          │  ────────────────────            │
    └─────────────────┘          │  • Carrega PDF com pdf-lib       │
                                 │  • Gera hash SHA-256 do documento │
                                 │  • Cria página de protocolo       │
                                 │  • Adiciona headers em todas      │
                                 │    as páginas                     │
                                 │  • Salva PDF modificado           │
                                 └────────────────┬────────────────┘
                                                  │
                                                  ▼
                    ┌──────────────────────────────────────────────┐
                    │  7. DOWNLOAD                                  │
                    │  ──────────                                   │
                    │  • Cria Blob do PDF finalizado                │
                    │  • Gera URL temporária                        │
                    │  • Dispara download                           │
                    │  • Nome: {original}_assinado_{count}x.pdf     │
                    │  • Limpa URL após download                    │
                    └──────────────────────────────────────────────┘
```

---

## Estrutura dos Dados

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           SignatureLog                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  documentId: "uuid-v4"                                                   │
│  createdAt: "2024-01-15T10:30:00.000Z"                                   │
│  updatedAt: "2024-01-15T10:35:00.000Z"                                   │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        PDFMetadata                                 │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │  fileName: "contrato.pdf"                                          │  │
│  │  fileSize: 1048576                                                 │  │
│  │  lastModified: 1705312200000                                       │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  signatures: [                                                           │
│    ┌─────────────────────────────────────────────────────────────────┐  │
│    │                      SignatureData #1                            │  │
│    ├─────────────────────────────────────────────────────────────────┤  │
│    │  id: "uuid-v4"                                                   │  │
│    │  name: "JOÃO DA SILVA"                                           │  │
│    │  cpf: "12345678901"                                              │  │
│    │  deviceId: "uuid-v4"                                             │  │
│    │  timestamp: "2024-01-15T10:30:00.000Z"                           │  │
│    │  hash: "a591a6d40bf420404a011733cfb7b190..."                     │  │
│    └─────────────────────────────────────────────────────────────────┘  │
│    ┌─────────────────────────────────────────────────────────────────┐  │
│    │                      SignatureData #2                            │  │
│    ├─────────────────────────────────────────────────────────────────┤  │
│    │  id: "uuid-v4"                                                   │  │
│    │  name: "MARIA SANTOS"                                            │  │
│    │  cpf: "98765432101"                                              │  │
│    │  deviceId: "uuid-v4"                                             │  │
│    │  timestamp: "2024-01-15T10:35:00.000Z"                           │  │
│    │  hash: "b692b7e50cf531515b122844dfc8c2a1..."                     │  │
│    └─────────────────────────────────────────────────────────────────┘  │
│  ]                                                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Geração do Hash

```
                 ┌─────────────────────────┐
                 │     PDF Bytes           │
                 │   (Uint8Array)          │
                 └───────────┬─────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────┐
│                         CONCATENAÇÃO                                │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [PDF_BYTES][|NAME:JOÃO DA SILVA|CPF:12345678901|DEVICE:uuid|TIME:ts|]
│                                                                     │
└────────────────────────────┬───────────────────────────────────────┘
                             │
                             ▼
                 ┌─────────────────────────┐
                 │     crypto.subtle       │
                 │     .digest('SHA-256')  │
                 └───────────┬─────────────┘
                             │
                             ▼
                 ┌─────────────────────────┐
                 │    Hash Buffer          │
                 │    (ArrayBuffer)        │
                 └───────────┬─────────────┘
                             │
                             ▼
                 ┌─────────────────────────┐
                 │  Conversão para Hex     │
                 │  (64 caracteres)        │
                 └───────────┬─────────────┘
                             │
                             ▼
    a591a6d40bf420404a011733cfb7b190d62c65bf0bcda32b57b277d9ad9f146e
```

---

## Estrutura do PDF Final

```
┌──────────────────────────────────────────────────────────────────────┐
│                          PDF FINALIZADO                               │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  PÁGINA 1 - PROTOCOLO DE ASSINATURAS (inserida)                │  │
│  │                                                                 │  │
│  │  ┌──────────────────────────────────────────────────────────┐  │  │
│  │  │ HEADER: HASH: A5-91-A6-D4-...  Página 1 de N             │  │  │
│  │  └──────────────────────────────────────────────────────────┘  │  │
│  │                                                                 │  │
│  │  ═══════════════════════════════════════════════                │  │
│  │  PROTOCOLO DE ASSINATURAS                                       │  │
│  │  ═══════════════════════════════════════════════                │  │
│  │                                                                 │  │
│  │  DOCUMENTO                                                      │  │
│  │  ─────────                                                      │  │
│  │  Nome do envelope: contrato                                     │  │
│  │  Autor: JOÃO DA SILVA                                           │  │
│  │  Status: Finalizado                                             │  │
│  │  HASH SICFAR: A5-91-A6-D4-0B-F4-20-40-...                       │  │
│  │  SHA256: a591a6d40bf420404a011733...                            │  │
│  │                                                                 │  │
│  │  ASSINATURAS                                                    │  │
│  │  ───────────                                                    │  │
│  │  Nome: JOÃO DA SILVA - CPF: 123.456.789-01                      │  │
│  │  Data: 15/01/2024 10:30:00                                      │  │
│  │  Status: Assinado eletronicamente ✓                             │  │
│  │  Device ID: uuid...                                             │  │
│  │  Hash: a591a6d4...ad9f146e                                      │  │
│  │                                                                 │  │
│  │  AUTENTICIDADE                                                  │  │
│  │  ─────────────                                                  │  │
│  │  ┌────────────────────────────────────────────────────────┐    │  │
│  │  │  HASH SICFAR: A5-91-A6-D4-0B-F4-20-40-...               │    │  │
│  │  └────────────────────────────────────────────────────────┘    │  │
│  │                                                                 │  │
│  │  Este documento foi assinado eletronicamente.                   │  │
│  │  Gerado em: 15/01/2024 10:40:00                                 │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  PÁGINA 2 - CONTEÚDO ORIGINAL (página 1 do PDF original)       │  │
│  │                                                                 │  │
│  │  ┌──────────────────────────────────────────────────────────┐  │  │
│  │  │ HEADER: HASH: A5-91-A6-D4-...  Página 2 de N             │  │  │
│  │  └──────────────────────────────────────────────────────────┘  │  │
│  │                                                                 │  │
│  │                    [CONTEÚDO ORIGINAL]                          │  │
│  │                                                                 │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  PÁGINA N - CONTEÚDO ORIGINAL (última página)                  │  │
│  │                                                                 │  │
│  │  ┌──────────────────────────────────────────────────────────┐  │  │
│  │  │ HEADER: HASH: A5-91-A6-D4-...  Página N de N             │  │  │
│  │  └──────────────────────────────────────────────────────────┘  │  │
│  │                                                                 │  │
│  │                    [CONTEÚDO ORIGINAL]                          │  │
│  │                                                                 │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Arquitetura de Componentes

```
                          ┌─────────────────────────┐
                          │         App.tsx         │
                          │  (Orquestrador Central) │
                          └───────────┬─────────────┘
                                      │
           ┌──────────────────────────┼──────────────────────────┐
           │                          │                          │
           ▼                          ▼                          ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│     PDFUpload       │  │     SignerForm      │  │     ActionBar       │
│   (Upload de PDF)   │  │   (Formulário)      │  │  (Ações e Device)   │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
           │                          │                          │
           ▼                          ▼                          │
┌─────────────────────┐  ┌─────────────────────┐                 │
│     PDFPreview      │  │   SignatureLog      │                 │
│  (Visualização)     │  │ (Lista assinaturas) │                 │
└─────────────────────┘  └─────────────────────┘                 │
                                                                  │
                         ┌────────────────────────────────────────┘
                         ▼
              ┌─────────────────────┐
              │     Serviços        │
              │  ┌───────────────┐  │
              │  │    pdf.ts     │  │
              │  │ (pdf-lib)     │  │
              │  └───────────────┘  │
              │  ┌───────────────┐  │
              │  │   utils/*     │  │
              │  │ (hash, cpf)   │  │
              │  └───────────────┘  │
              └─────────────────────┘
```

---

## LocalStorage

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           localStorage                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Key: "pdf_signature_device_id"                                  │    │
│  │  Value: "550e8400-e29b-41d4-a716-446655440000"                   │    │
│  │  (UUID v4 - gerado uma vez, persistente)                         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Key: "pdf_signature_current_log"                                │    │
│  │  Value: { ... SignatureLog serializado em JSON ... }             │    │
│  │  (Atualizado a cada assinatura)                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```
